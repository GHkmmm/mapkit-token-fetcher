<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MapKit Token éªŒè¯ç è¾“å…¥</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 40px;
      max-width: 420px;
      width: 100%;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
    }

    .logo {
      text-align: center;
      margin-bottom: 24px;
    }

    .logo span {
      font-size: 48px;
    }

    h1 {
      text-align: center;
      color: #1a1a2e;
      font-size: 24px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .subtitle {
      text-align: center;
      color: #666;
      font-size: 14px;
      margin-bottom: 32px;
    }

    .status-card {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
    }

    .status-label {
      color: #666;
      font-size: 13px;
    }

    .status-value {
      font-weight: 500;
      font-size: 13px;
    }

    .status-pending { color: #6c757d; }
    .status-running { color: #0d6efd; }
    .status-waiting_verification { color: #fd7e14; }
    .status-verifying { color: #0dcaf0; }
    .status-completed { color: #198754; }
    .status-failed { color: #dc3545; }
    .status-cancelled { color: #6c757d; }
    .status-timeout { color: #dc3545; }

    .code-input-container {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-bottom: 24px;
    }

    .code-input {
      width: 48px;
      height: 56px;
      text-align: center;
      font-size: 24px;
      font-weight: 600;
      border: 2px solid #e0e0e0;
      border-radius: 12px;
      outline: none;
      transition: all 0.2s;
    }

    .code-input:focus {
      border-color: #0d6efd;
      box-shadow: 0 0 0 3px rgba(13, 110, 253, 0.15);
    }

    .code-input:disabled {
      background: #f5f5f5;
      color: #999;
    }

    .btn {
      width: 100%;
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 12px;
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(13, 110, 253, 0.3);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc3545 0%, #bb2d3b 100%);
      color: white;
    }

    .btn-danger:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(220, 53, 69, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover:not(:disabled) {
      background: #5c636a;
    }

    .message {
      text-align: center;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .message-success {
      background: #d1e7dd;
      color: #0f5132;
    }

    .message-error {
      background: #f8d7da;
      color: #842029;
    }

    .message-warning {
      background: #fff3cd;
      color: #664d03;
    }

    .message-info {
      background: #cff4fc;
      color: #055160;
    }

    .hidden {
      display: none !important;
    }

    .loading {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
      vertical-align: middle;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .timer {
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-top: 16px;
    }

    .timer-warning {
      color: #fd7e14;
    }

    .timer-danger {
      color: #dc3545;
    }

    .footer {
      text-align: center;
      margin-top: 24px;
      color: #999;
      font-size: 12px;
    }

    .result-token {
      background: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
      word-break: break-all;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 11px;
      max-height: 120px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <span>ğŸ</span>
    </div>
    <h1>MapKit Token åˆ·æ–°</h1>
    <p class="subtitle">è¯·è¾“å…¥ Apple ID ä¸¤æ­¥éªŒè¯ç </p>

    <!-- çŠ¶æ€å¡ç‰‡ -->
    <div class="status-card">
      <div class="status-row">
        <span class="status-label">ä»»åŠ¡ ID</span>
        <span class="status-value" id="taskId">-</span>
      </div>
      <div class="status-row">
        <span class="status-label">çŠ¶æ€</span>
        <span class="status-value" id="taskStatus">åŠ è½½ä¸­...</span>
      </div>
    </div>

    <!-- æ¶ˆæ¯æç¤º -->
    <div id="message" class="message hidden"></div>

    <!-- éªŒè¯ç è¾“å…¥ -->
    <div id="codeSection">
      <div class="code-input-container">
        <input type="text" class="code-input" maxlength="1" data-index="0" inputmode="numeric">
        <input type="text" class="code-input" maxlength="1" data-index="1" inputmode="numeric">
        <input type="text" class="code-input" maxlength="1" data-index="2" inputmode="numeric">
        <input type="text" class="code-input" maxlength="1" data-index="3" inputmode="numeric">
        <input type="text" class="code-input" maxlength="1" data-index="4" inputmode="numeric">
        <input type="text" class="code-input" maxlength="1" data-index="5" inputmode="numeric">
      </div>

      <button id="submitBtn" class="btn btn-primary" disabled>
        æäº¤éªŒè¯ç 
      </button>

      <button id="cancelBtn" class="btn btn-danger">
        å¼ºåˆ¶å–æ¶ˆä»»åŠ¡
      </button>

      <div id="timer" class="timer"></div>
    </div>

    <!-- è¶…æ—¶/å¤±è´¥åçš„æ“ä½œ -->
    <div id="retrySection" class="hidden">
      <button id="retryBtn" class="btn btn-primary">
        é‡æ–°å‘èµ·ä»»åŠ¡
      </button>
    </div>

    <!-- å®Œæˆåæ˜¾ç¤º -->
    <div id="resultSection" class="hidden">
      <div id="resultToken" class="result-token"></div>
    </div>

    <div class="footer">
      MapKit Token Fetcher
    </div>
  </div>

  <script>
    // è·å– URL å‚æ•°
    const urlParams = new URLSearchParams(window.location.search);
    const taskId = urlParams.get('taskId');

    // DOM å…ƒç´ 
    const taskIdEl = document.getElementById('taskId');
    const taskStatusEl = document.getElementById('taskStatus');
    const messageEl = document.getElementById('message');
    const codeSectionEl = document.getElementById('codeSection');
    const retrySectionEl = document.getElementById('retrySection');
    const resultSectionEl = document.getElementById('resultSection');
    const resultTokenEl = document.getElementById('resultToken');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const retryBtn = document.getElementById('retryBtn');
    const timerEl = document.getElementById('timer');
    const codeInputs = document.querySelectorAll('.code-input');

    let pollInterval = null;
    let countdownInterval = null;

    // çŠ¶æ€æ–‡æœ¬æ˜ å°„
    const statusTextMap = {
      'pending': 'ç­‰å¾…å¼€å§‹',
      'running': 'æ‰§è¡Œä¸­',
      'waiting_verification': 'ç­‰å¾…éªŒè¯ç ',
      'verifying': 'éªŒè¯ä¸­',
      'completed': 'å·²å®Œæˆ',
      'failed': 'å¤±è´¥',
      'cancelled': 'å·²å–æ¶ˆ',
      'timeout': 'å·²è¶…æ—¶'
    };

    // åˆå§‹åŒ–
    function init() {
      if (!taskId) {
        showMessage('error', 'ç¼ºå°‘ä»»åŠ¡ ID å‚æ•°');
        disableInputs();
        return;
      }

      taskIdEl.textContent = taskId;
      setupCodeInputs();
      fetchTaskStatus();
      pollInterval = setInterval(fetchTaskStatus, 2000);
    }

    // è®¾ç½®éªŒè¯ç è¾“å…¥æ¡†
    function setupCodeInputs() {
      codeInputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
          const value = e.target.value.replace(/\D/g, '');
          e.target.value = value;
          
          if (value && index < 5) {
            codeInputs[index + 1].focus();
          }
          
          checkCodeComplete();
        });

        input.addEventListener('keydown', (e) => {
          if (e.key === 'Backspace' && !e.target.value && index > 0) {
            codeInputs[index - 1].focus();
          }
        });

        input.addEventListener('paste', (e) => {
          e.preventDefault();
          const paste = (e.clipboardData || window.clipboardData).getData('text');
          const digits = paste.replace(/\D/g, '').slice(0, 6);
          
          digits.split('').forEach((digit, i) => {
            if (codeInputs[i]) {
              codeInputs[i].value = digit;
            }
          });
          
          checkCodeComplete();
          if (digits.length > 0) {
            codeInputs[Math.min(digits.length, 5)].focus();
          }
        });
      });

      submitBtn.addEventListener('click', submitCode);
      cancelBtn.addEventListener('click', cancelTask);
      retryBtn.addEventListener('click', retryTask);
    }

    // æ£€æŸ¥éªŒè¯ç æ˜¯å¦å®Œæ•´
    function checkCodeComplete() {
      const code = getCode();
      submitBtn.disabled = code.length !== 6;
    }

    // è·å–éªŒè¯ç 
    function getCode() {
      return Array.from(codeInputs).map(input => input.value).join('');
    }

    // è·å–ä»»åŠ¡çŠ¶æ€
    async function fetchTaskStatus() {
      try {
        const response = await fetch(`/api/task/${taskId}`);
        const data = await response.json();

        if (!data.success) {
          showMessage('error', data.error || 'è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥');
          stopPolling();
          return;
        }

        const task = data.task;
        updateUI(task);
      } catch (error) {
        console.error('è·å–ä»»åŠ¡çŠ¶æ€å¤±è´¥:', error);
      }
    }

    // æ›´æ–° UI
    function updateUI(task) {
      const status = task.status;
      taskStatusEl.textContent = statusTextMap[status] || status;
      taskStatusEl.className = `status-value status-${status}`;

      // æ ¹æ®çŠ¶æ€æ˜¾ç¤ºä¸åŒ UI
      switch (status) {
        case 'waiting_verification':
          showCodeSection();
          updateTimer(task.expiresAt);
          break;
        case 'verifying':
          showMessage('info', 'æ­£åœ¨éªŒè¯...');
          disableInputs();
          break;
        case 'completed':
          showMessage('success', 'Token åˆ·æ–°æˆåŠŸï¼');
          hideCodeSection();
          if (task.result?.token) {
            resultSectionEl.classList.remove('hidden');
            resultTokenEl.textContent = task.result.token;
          }
          stopPolling();
          break;
        case 'failed':
          showMessage('error', task.result?.error || 'ä»»åŠ¡å¤±è´¥');
          showRetrySection();
          stopPolling();
          break;
        case 'cancelled':
          showMessage('warning', 'ä»»åŠ¡å·²å–æ¶ˆ');
          showRetrySection();
          stopPolling();
          break;
        case 'timeout':
          showMessage('warning', 'éªŒè¯ç å·²è¶…æ—¶ï¼Œè¯·é‡æ–°å‘èµ·ä»»åŠ¡');
          showRetrySection();
          stopPolling();
          break;
        case 'pending':
        case 'running':
          showMessage('info', 'ä»»åŠ¡æ­£åœ¨å‡†å¤‡ä¸­ï¼Œè¯·ç¨å€™...');
          disableInputs();
          break;
      }
    }

    // æ›´æ–°å€’è®¡æ—¶
    function updateTimer(expiresAt) {
      const update = () => {
        const now = new Date();
        const expires = new Date(expiresAt);
        const remaining = Math.max(0, Math.floor((expires - now) / 1000));

        if (remaining <= 0) {
          timerEl.textContent = 'éªŒè¯ç å·²è¿‡æœŸ';
          timerEl.className = 'timer timer-danger';
          clearInterval(countdownInterval);
          return;
        }

        const minutes = Math.floor(remaining / 60);
        const seconds = remaining % 60;
        timerEl.textContent = `å‰©ä½™æ—¶é—´: ${minutes}:${seconds.toString().padStart(2, '0')}`;

        if (remaining <= 60) {
          timerEl.className = 'timer timer-danger';
        } else if (remaining <= 120) {
          timerEl.className = 'timer timer-warning';
        } else {
          timerEl.className = 'timer';
        }
      };

      update();
      if (countdownInterval) clearInterval(countdownInterval);
      countdownInterval = setInterval(update, 1000);
    }

    // æäº¤éªŒè¯ç 
    async function submitCode() {
      const code = getCode();
      if (code.length !== 6) return;

      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="loading"></span>æäº¤ä¸­...';

      try {
        const response = await fetch(`/api/task/${taskId}/verify`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ code })
        });

        const data = await response.json();

        if (data.success) {
          // æäº¤æˆåŠŸï¼Œç«‹å³ç»“æŸ loading çŠ¶æ€
          submitBtn.textContent = 'å·²æäº¤';
          submitBtn.disabled = true;  // ä¿æŒç¦ç”¨ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
          showMessage('success', 'âœ… éªŒè¯ç æäº¤æˆåŠŸï¼Œè¯·ç­‰å¾…ä¼ä¸šå¾®ä¿¡é€šçŸ¥ä»»åŠ¡ç»“æœ');
          // ç¦ç”¨æ‰€æœ‰è¾“å…¥ï¼Œä½†åœæ­¢è½®è¯¢ï¼ˆç”¨æˆ·æ— éœ€ç»§ç»­ç­‰å¾…é¡µé¢ï¼‰
          disableInputs();
          stopPolling();
          // éšè—å€’è®¡æ—¶
          timerEl.textContent = '';
        } else {
          showMessage('error', data.error || 'æäº¤å¤±è´¥');
          submitBtn.disabled = false;
          submitBtn.textContent = 'æäº¤éªŒè¯ç ';
          // æ¸…ç©ºè¾“å…¥æ¡†
          codeInputs.forEach(input => input.value = '');
          codeInputs[0].focus();
        }
      } catch (error) {
        showMessage('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        submitBtn.disabled = false;
        submitBtn.textContent = 'æäº¤éªŒè¯ç ';
      }
    }

    // å–æ¶ˆä»»åŠ¡
    async function cancelTask() {
      if (!confirm('ç¡®å®šè¦å–æ¶ˆä»»åŠ¡å—ï¼Ÿ')) return;

      cancelBtn.disabled = true;
      cancelBtn.innerHTML = '<span class="loading"></span>å–æ¶ˆä¸­...';

      try {
        const response = await fetch(`/api/task/${taskId}/cancel`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showMessage('warning', 'ä»»åŠ¡å·²å–æ¶ˆ');
          showRetrySection();
        } else {
          showMessage('error', data.error || 'å–æ¶ˆå¤±è´¥');
          cancelBtn.disabled = false;
          cancelBtn.textContent = 'å¼ºåˆ¶å–æ¶ˆä»»åŠ¡';
        }
      } catch (error) {
        showMessage('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        cancelBtn.disabled = false;
        cancelBtn.textContent = 'å¼ºåˆ¶å–æ¶ˆä»»åŠ¡';
      }
    }

    // é‡è¯•ä»»åŠ¡
    async function retryTask() {
      retryBtn.disabled = true;
      retryBtn.innerHTML = '<span class="loading"></span>å‘èµ·ä¸­...';

      try {
        const response = await fetch(`/api/task/${taskId}/retry`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          // è·³è½¬åˆ°æ–°ä»»åŠ¡é¡µé¢
          window.location.href = `/refresh?taskId=${data.taskId}`;
        } else {
          showMessage('error', data.error || 'é‡è¯•å¤±è´¥');
          retryBtn.disabled = false;
          retryBtn.textContent = 'é‡æ–°å‘èµ·ä»»åŠ¡';
        }
      } catch (error) {
        showMessage('error', 'ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        retryBtn.disabled = false;
        retryBtn.textContent = 'é‡æ–°å‘èµ·ä»»åŠ¡';
      }
    }

    // æ˜¾ç¤ºæ¶ˆæ¯
    function showMessage(type, text) {
      messageEl.textContent = text;
      messageEl.className = `message message-${type}`;
      messageEl.classList.remove('hidden');
    }

    // æ˜¾ç¤ºéªŒè¯ç è¾“å…¥åŒºåŸŸ
    function showCodeSection() {
      codeSectionEl.classList.remove('hidden');
      retrySectionEl.classList.add('hidden');
      resultSectionEl.classList.add('hidden');
      enableInputs();
    }

    // éšè—éªŒè¯ç è¾“å…¥åŒºåŸŸ
    function hideCodeSection() {
      codeSectionEl.classList.add('hidden');
    }

    // æ˜¾ç¤ºé‡è¯•åŒºåŸŸ
    function showRetrySection() {
      codeSectionEl.classList.add('hidden');
      retrySectionEl.classList.remove('hidden');
    }

    // ç¦ç”¨è¾“å…¥
    function disableInputs() {
      codeInputs.forEach(input => input.disabled = true);
      submitBtn.disabled = true;
      cancelBtn.disabled = true;
    }

    // å¯ç”¨è¾“å…¥
    function enableInputs() {
      codeInputs.forEach(input => input.disabled = false);
      cancelBtn.disabled = false;
      checkCodeComplete();
    }

    // åœæ­¢è½®è¯¢
    function stopPolling() {
      if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
      }
      if (countdownInterval) {
        clearInterval(countdownInterval);
        countdownInterval = null;
      }
    }

    // å¯åŠ¨
    init();
  </script>
</body>
</html>
