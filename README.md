# MapKit Token Refresh Tool

è‡ªåŠ¨åˆ·æ–° Apple MapKit Server Token çš„å‘½ä»¤è¡Œå·¥å…·ï¼ŒåŸºäº Playwright å®ç°æµè§ˆå™¨è‡ªåŠ¨åŒ–æ“ä½œã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ ä½¿ç”¨ `npx` å‘½ä»¤å¿«é€Ÿè°ƒç”¨
- ğŸ–¥ï¸ æ”¯æŒ headed/headless ä¸¤ç§æµè§ˆå™¨æ¨¡å¼
- ğŸ“„ é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†è´¦å·å¯†ç 
- ğŸ” è‡ªåŠ¨å¤„ç†ä¸¤æ­¥éªŒè¯å’Œä¿¡ä»»æµè§ˆå™¨
- ğŸ“¤ Token ç›´æ¥è¾“å‡ºåˆ° stdout

## å®‰è£…

```bash
# å®‰è£…ä¾èµ–
npm install

# å®‰è£… Playwright æµè§ˆå™¨
npx playwright install chromium

# æ„å»ºé¡¹ç›®
npm run build
```

## é…ç½®

åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `config.yaml` æ–‡ä»¶ï¼Œå¡«å†™æ‚¨çš„ Apple Developer è´¦æˆ·å‡­è¯ï¼š

```yaml
# config.yaml
apple:
  username: your-apple-id@example.com
  password: your-password
```

> âš ï¸ **å®‰å…¨æç¤º**: `config.yaml` åŒ…å«æ•æ„Ÿå‡­è¯ï¼Œè¯¥æ–‡ä»¶å·²è‡ªåŠ¨æ·»åŠ åˆ° `.gitignore`ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¸Šä¼ æˆ–åˆ†äº«ã€‚

æ‚¨å¯ä»¥å‚è€ƒ `config.yaml.example` æ–‡ä»¶ä½œä¸ºæ¨¡æ¿ã€‚

## ä½¿ç”¨æ–¹æ³•

### åˆ·æ–° MapKit Token

```bash
npm run dev -- refresh
```

ç¨‹åºä¼šè‡ªåŠ¨è¯»å– `config.yaml` ä¸­çš„å‡­è¯å¹¶æ‰§è¡Œæ“ä½œï¼š

```
ğŸ MapKit Token Refresh Tool
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸ“‹ åŠŸèƒ½: ç™»å½•å¹¶åˆ›å»ºæ–°çš„ MapKit Token

ğŸ“§ Apple ID: your@email.com
ğŸ”‘ å¯†ç : ************
```

### è·å–ç°æœ‰ Token

```bash
npm run dev -- get
```

### ä»…æ‰“å¼€æµè§ˆå™¨

```bash
npm run dev -- open
```

### å°† Token è¾“å‡ºåˆ°æ–‡ä»¶

```bash
npm run dev -- get -o ./token.txt
npm run dev -- refresh --out ./new-token.txt
```

### å‘½ä»¤è¡Œé€‰é¡¹

```
Commands:
  open [options]     æ‰“å¼€æµè§ˆå™¨å¹¶è·³è½¬åˆ° Apple Developer åå°
  get [options]      ç™»å½•å¹¶è·å–ç°æœ‰ MapKit Token
  refresh [options]  ç™»å½•å¹¶åˆ›å»ºæ–°çš„ MapKit Token

get/refresh é€‰é¡¹:
  -o, --out <path>           å°† Token è¾“å‡ºåˆ°æŒ‡å®šæ–‡ä»¶è·¯å¾„
  --headless                 ä½¿ç”¨æ— å¤´æ¨¡å¼ï¼ˆé»˜è®¤: falseï¼‰
  --no-auth-cache            ä¸ä½¿ç”¨ç¼“å­˜çš„ç™»å½•çŠ¶æ€ï¼ˆå¼ºåˆ¶é‡æ–°ç™»å½•ï¼‰
```

## ç™»å½•æµç¨‹è¯´æ˜

1. **è´¦å·å¯†ç ç™»å½•** - è‡ªåŠ¨å¡«å……è´¦å·å¯†ç å¹¶æäº¤
2. **è®°ä½è´¦æˆ·** - è‡ªåŠ¨å‹¾é€‰"è®°ä½æˆ‘çš„è´¦æˆ·"é€‰é¡¹
3. **ä¸¤æ­¥éªŒè¯** - æ£€æµ‹åˆ°æ—¶ä¼šåœ¨ç»ˆç«¯æç¤ºè¾“å…¥6ä½éªŒè¯ç 
4. **ä¿¡ä»»æµè§ˆå™¨** - è‡ªåŠ¨ç‚¹å‡»"ä¿¡ä»»"æŒ‰é’®ï¼ˆå¦‚å‡ºç°ï¼‰
5. **Token æå–** - ç™»å½•æˆåŠŸåè‡ªåŠ¨æå–å¹¶è¾“å‡º Token

## ç™»å½•çŠ¶æ€æŒä¹…åŒ–

å·¥å…·æ”¯æŒç¼“å­˜ç™»å½•çŠ¶æ€ï¼Œé¦–æ¬¡ç™»å½•åå¯è·³è¿‡ä¸¤æ­¥éªŒè¯ï¼š

### å·¥ä½œåŸç†

- é¦–æ¬¡ç™»å½•æˆåŠŸåï¼Œç™»å½•çŠ¶æ€ä¼šä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `.auth-state.json` æ–‡ä»¶
- åç»­è¿è¡Œæ—¶è‡ªåŠ¨åŠ è½½è¯¥æ–‡ä»¶ï¼Œè·³è¿‡ç™»å½•å’Œä¸¤æ­¥éªŒè¯æµç¨‹
- ç™»å½•çŠ¶æ€é€šå¸¸åœ¨ 30 å¤©å†…æœ‰æ•ˆ

### ä½¿ç”¨æ–¹å¼

```bash
# é¦–æ¬¡ç™»å½•ï¼ˆéœ€è¦ä¸¤æ­¥éªŒè¯ï¼‰
npm run dev -- get

# åç»­ä½¿ç”¨ï¼ˆè‡ªåŠ¨è·³è¿‡ä¸¤æ­¥éªŒè¯ï¼‰
npm run dev -- get

# å¼ºåˆ¶é‡æ–°ç™»å½•ï¼ˆå¿½ç•¥ç¼“å­˜ï¼‰
npm run dev -- get --no-auth-cache
```

> âš ï¸ **å®‰å…¨æç¤º**: `.auth-state.json` åŒ…å«æ•æ„Ÿçš„ç™»å½•å‡­è¯ï¼Œè¯¥æ–‡ä»¶å·²è‡ªåŠ¨æ·»åŠ åˆ° `.gitignore`ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¸Šä¼ æˆ–åˆ†äº«ã€‚

## Linux æœåŠ¡å™¨éƒ¨ç½²

```bash
# å®‰è£…ç³»ç»Ÿä¾èµ–
npx playwright install-deps chromium

# å®šæ—¶ä»»åŠ¡ç¤ºä¾‹ï¼ˆæ¯å¤©å‡Œæ™¨ 2 ç‚¹ï¼‰
0 2 * * * cd /path/to/tool && node dist/cli.js refresh --headless >> /var/log/mapkit-token.log 2>&1
```

> æ³¨æ„ï¼šæœåŠ¡å™¨ä¸Šéœ€è¦æå‰é…ç½®å¥½ `config.yaml` æ–‡ä»¶ï¼Œä¸” `--headless` æ¨¡å¼éœ€é…åˆ `.auth-state.json` ä½¿ç”¨ï¼ˆé¦–æ¬¡éœ€åœ¨æœ¬åœ°å®Œæˆç™»å½•ä»¥ç”Ÿæˆè®¤è¯ç¼“å­˜ï¼‰ã€‚

## é¡¹ç›®ç»“æ„

```
mapkit-token-fetcher/
â”œâ”€â”€ package.json          # npm é…ç½®
â”œâ”€â”€ tsconfig.json         # TypeScript é…ç½®
â”œâ”€â”€ README.md             # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ config.yaml           # å‡­è¯é…ç½®ï¼ˆéœ€æ‰‹åŠ¨åˆ›å»ºï¼‰
â”œâ”€â”€ config.yaml.example   # é…ç½®æ–‡ä»¶æ¨¡æ¿
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ cli.ts            # CLI å…¥å£
â”‚   â”œâ”€â”€ browser.ts        # æµè§ˆå™¨è‡ªåŠ¨åŒ–
â”‚   â”œâ”€â”€ config.ts         # é…ç½®æ–‡ä»¶è¯»å–
â”‚   â”œâ”€â”€ input.ts          # äº¤äº’å¼è¾“å…¥
â”‚   â””â”€â”€ types.ts          # ç±»å‹å®šä¹‰
â””â”€â”€ dist/                 # ç¼–è¯‘è¾“å‡º
```

## License

MIT
